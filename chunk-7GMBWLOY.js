import{a as O,b as I,c as W,d as Ie,e as Y,f as J,g as Fe,h as Z,i as Me,j as X,k as ee,l as te,m as Ue,n as Ve}from"./chunk-YVYEINFY.js";import{$ as Ce,Aa as Ne,Ba as $,D as N,Da as Q,E as U,Ea as L,G as V,H as p,Ha as H,Ia as Le,Ja as C,K as d,Ka as P,La as Oe,O as E,R as v,T as ke,W as be,X as Pe,Y as i,Z as r,_ as f,a as m,aa as u,b as h,ba as _,c as D,ca as c,da as k,e as ge,f as Te,fa as we,g as A,ga as z,ha as B,i as he,ia as K,k as M,l as Ee,m as G,r as T,ra as xe,t as q,u as s,ua as b,v as _e,wa as Ae,xa as Re,y as ve,z as ye,za as Ge}from"./chunk-CXYLFGD3.js";function je(n,e=!1){let o=new Uint8Array(n).reduce((l,S)=>`${l}${String.fromCharCode(S)}`,""),a=btoa(o);return e?Je(a):a}function Je(n){return n.replaceAll(/\+/g,"-").replaceAll(/\//g,"_").replace(/=/g,"")}function Se(n){let e=new Uint32Array(n/2);return crypto.getRandomValues(e),Array.from(e,t=>`0${t.toString(16)}`.slice(-2)).join("")}async function qe(n){let t=new TextEncoder().encode(n);return crypto.subtle.digest("SHA-256",t)}var ne=class extends Error{name=this.constructor.name;constructor(e="Access Token not Found!!!",t){super(e,t)}},oe=class extends Error{name=this.constructor.name;constructor(e,t){super(`State token '${e}' is not found or expired!!`,t)}},ae=new q("key-value-storage");var De="oauth",Ze=32,Xe=54,et=10*60*1e3,tt=1e3*10,ze=new q("oauth-configuration");function Be(n){return _e([{provide:ze,useValue:n},g])}var g=class n{config=s(ze);storage=s(ae);http=s(L);storageStateDataKey=`${De}-${this.config.name}-state-data`;storeRefreshTokenDataKey=`${De}-${this.config.name}-refresh-token-data`;storeAccessTokenDataKey=`${De}-${this.config.name}-access-token-data`;async fetchRefreshTokenData(){return this.storage.get(this.storeRefreshTokenDataKey)}async storeRefreshTokenData(e){return await this.storage.set(this.storeRefreshTokenDataKey,e),e}async removeRefreshTokenData(){return this.storage.remove(this.storeRefreshTokenDataKey)}async refreshAccessTokenData(){let e=await this.fetchRefreshTokenData();if(e){let t=await A(this.http.post(this.config.accessTokenUrl,{client_id:this.config.clientId,client_secret:this.config.clientSecret,grant_type:"refresh_token",refresh_token:e}).pipe(M(o=>(console.error(o?.error??o),Te(null)))));if(t!==null)return await this.storeAccessTokenData(t)}return null}async getAccessTokenData(){let e=await this.fetchAccessTokenData();return e&&e.expiredAt>=Date.now()?e:this.refreshAccessTokenData()}accessTokenResource=Re({loader:async()=>(await this.getAccessTokenData())?.access_token??null});accessToken=b(this.accessTokenResource.value,{equal:(e,t)=>typeof t>"u"||Object.is(e,t)});ready=b(()=>{let e=this.accessToken();return typeof e>"u"?void 0:e!==null});async fetchAccessTokenData(){return await this.storage.get(this.storeAccessTokenDataKey)}async storeAccessTokenData(e){let l=e,{refresh_token:t}=l,o=D(l,["refresh_token"]);t&&await this.storeRefreshTokenData(t);let a=h(m({},o),{expiredAt:Date.now()+e.expires_in*1e3-tt});return await this.storage.set(this.storeAccessTokenDataKey,a),this.accessTokenResource.set(a.access_token),a}async getAccessTokenHeaders(){let e=await this.getAccessTokenData();if(e?.access_token){let{token_type:t,access_token:o}=e;return{Authorization:`${t[0].toUpperCase()}${t.slice(1)} ${o}`}}throw new ne}async removeAccessTokenData(){await this.storage.remove(this.storeAccessTokenDataKey),this.accessTokenResource.set(null)}async fetchStateData(e){let t=await this.storage.get(this.storageStateDataKey)??{},o=Date.now(),a=Object.fromEntries(Object.entries(t).filter(([l,S])=>S.expiredAt>=o));return await this.storeStateDataRecord(a),t[e]??null}async storeStateData(e,t){let o=await this.storage.get(this.storageStateDataKey)??{},a=h(m({},t),{expiredAt:Date.now()+et});return o[e]=a,await this.storeStateDataRecord(o),a}async removeStateData(e){let t=await this.storage.get(this.storageStateDataKey)??{};return delete t[e],await this.storeStateDataRecord(t)}async clearStateDataRecord(){return await this.storage.remove(this.storageStateDataKey)}async storeStateDataRecord(e){return Object.keys(e).length===0?await this.clearStateDataRecord():await this.storage.set(this.storageStateDataKey,e)}async createStateData(e){let t=Se(Ze),o=Se(Xe),a=je(await qe(o),!0);return await this.storeStateData(t,{codeVerifier:o,state:e}),{stateToken:t,codeChallenge:a}}async getAuthorizationCodeUrl(e,{state:t={},additionalParam:o={}}={}){if(this.config.authorizationCodeUrl){let a=new URL(this.config.authorizationCodeUrl),{stateToken:l,codeChallenge:S}=await this.createStateData(t);return a.searchParams.set("client_id",this.config.clientId),a.searchParams.set("redirect_uri",this.config.redirectUri),a.searchParams.set("response_type","code"),a.searchParams.set("scope",e.join(" ")),a.searchParams.set("code_challenge",S),a.searchParams.set("code_challenge_method","S256"),a.searchParams.set("state",l),Object.entries(o).forEach(([j,Ye])=>a.searchParams.set(j,Ye)),a}else return null}async exchangeAuthorizationCode(e,t){let o=await this.fetchStateData(t);if(o===null)throw new oe(t);return await this.storeAccessTokenData(await A(this.http.post(this.config.accessTokenUrl,{client_id:this.config.clientId,client_secret:this.config.clientSecret,code:e,code_verifier:o.codeVerifier,grant_type:"authorization_code",redirect_uri:this.config.redirectUri}))),await this.removeStateData(t),o.state}async clear(){await Promise.all([this.removeRefreshTokenData(),this.removeAccessTokenData(),this.storage.remove(this.storageStateDataKey)])}static \u0275fac=function(t){return new(t||n)};static \u0275prov=T({token:n,factory:n.\u0275fac})};var w=class n{http=s(L);oauthService=s(g);apiUrl="https://people.googleapis.com/v1";getHeaders(){return this.oauthService.getAccessTokenHeaders()}getContacts(e){return ge(this.getHeaders()).pipe(G(t=>this.http.get(`${this.apiUrl}/people/me/connections`,{headers:t,params:e})),M(t=>{throw new Error("Failed to fetch contacts: "+t.message)}))}createContact(e,t){return ge(this.getHeaders()).pipe(G(o=>this.http.post(`${this.apiUrl}/people:createContact`,e,{headers:o,params:t})),M(o=>{throw new Error("Failed to create contact: "+o.message)}))}static \u0275fac=function(t){return new(t||n)};static \u0275prov=T({token:n,factory:n.\u0275fac,providedIn:"root"})};function ot(n,e){if(n&1&&(i(0,"li"),c(1),r()),n&2){let t=e.$implicit,o=_();p(),we(" ",o.getDisplayName(t)||"No name"," - ",o.getEmail(t)||"No email"," ")}}function at(n,e){n&1&&(i(0,"p"),c(1,"No contacts found"),r())}function rt(n,e){if(n&1&&(i(0,"p"),c(1),r()),n&2){let t=_();p(),k(t.error())}}var re=class n{contactsService=s(w);oauthService=s(g);router=s(C);contacts=V([]);error=V(null);constructor(){Ae(()=>{console.log("Contacts signal updated:",this.contacts()),console.log("Error signal updated:",this.error())})}async ngOnInit(){console.log("ContactsListComponent: ngOnInit started");let e=await this.oauthService.getAccessTokenData();if(console.log("Access Token:",e),!e){console.log("No access token, redirecting to /login"),this.router.navigate(["/login"]);return}await this.loadContacts()}async loadContacts(){try{console.log("Loading contacts...");let e={personFields:"names,emailAddresses"},t=await A(this.contactsService.getContacts(e));console.log("API Response:",t),this.contacts.set([...t.connections||[]]),console.log("Contacts set:",this.contacts()),this.error.set(null)}catch(e){this.error.set(e.message||"Failed to load contacts"),console.error("Error loading contacts:",e)}}async signOut(){await this.oauthService.clear(),this.router.navigate(["/login"])}getDisplayName(e){let t=e.names?.[0]?.displayName;return console.log("getDisplayName for contact:",e,"result:",t),t||""}getEmail(e){let t=e.emailAddresses?.[0]?.value;return console.log("getEmail for contact:",e,"result:",t),t||""}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-contacts-list"]],decls:8,vars:3,consts:[[4,"ngFor","ngForOf"],[4,"ngIf"],["routerLink","create"]],template:function(t,o){t&1&&(i(0,"h2"),c(1,"Contacts List"),r(),i(2,"ul"),E(3,ot,2,2,"li",0),r(),E(4,at,2,0,"p",1),i(5,"button",2),c(6,"Create Contact"),r(),E(7,rt,2,1,"p",1)),t&2&&(p(3),v("ngForOf",o.contacts()),p(),v("ngIf",o.contacts().length===0&&!o.error()),p(3),v("ngIf",o.error()))},dependencies:[Q,Ne,$,ee,P],encapsulation:2,changeDetection:0})};function it(n,e){if(n&1&&(i(0,"p"),c(1),r()),n&2){let t=_();p(),k(t.error())}}var ie=class n{contactsService=s(w);router=s(C);newContact={givenName:"",familyName:"",email:""};error=V(null);async createContact(){try{console.log("Creating contact...");let e={names:[{givenName:this.newContact.givenName,familyName:this.newContact.familyName}],emailAddresses:[{value:this.newContact.email}]},t=await A(this.contactsService.createContact(e));console.log("Contact created:",t),this.newContact={givenName:"",familyName:"",email:""},this.error.set(null),this.router.navigate(["/google/contacts"])}catch(e){this.error.set(e.message||"Failed to create contact"),console.error("Error creating contact:",e)}}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-create-contacts-form"]],decls:10,vars:4,consts:[["placeholder","Given Name",3,"ngModelChange","ngModel"],["placeholder","Family Name",3,"ngModelChange","ngModel"],["placeholder","Email",3,"ngModelChange","ngModel"],[3,"click"],["routerLink","../"],[4,"ngIf"]],template:function(t,o){t&1&&(i(0,"h3"),c(1,"Create New Contact"),r(),i(2,"input",0),K("ngModelChange",function(l){return B(o.newContact.givenName,l)||(o.newContact.givenName=l),l}),r(),i(3,"input",1),K("ngModelChange",function(l){return B(o.newContact.familyName,l)||(o.newContact.familyName=l),l}),r(),i(4,"input",2),K("ngModelChange",function(l){return B(o.newContact.email,l)||(o.newContact.email=l),l}),r(),i(5,"button",3),u("click",function(){return o.createContact()}),c(6,"Add Contact"),r(),i(7,"button",4),c(8,"Back to List"),r(),E(9,it,2,1,"p",5)),t&2&&(p(2),z("ngModel",o.newContact.givenName),p(),z("ngModel",o.newContact.familyName),p(),z("ngModel",o.newContact.email),p(5),v("ngIf",o.error()))},dependencies:[Q,$,ee,O,I,Ie,P],encapsulation:2,changeDetection:0})};var se=class n{data=U();formSubmit=N();formCancel=N();fb=s(X).nonNullable;formGroup=b(()=>{let e=this.fb,t=this.data();return this.fb.group({summary:e.control(t?.summary??"",{updateOn:"blur"}),description:e.control(t?.description??"",{updateOn:"blur"}),start:e.group({dateTime:e.control(t?.start?.dateTime??"",{updateOn:"blur"}),timeZone:e.control(Intl.DateTimeFormat().resolvedOptions().timeZone,{updateOn:"blur"})}),end:e.group({dateTime:e.control(t?.end?.dateTime??"",{updateOn:"blur"}),timeZone:e.control(Intl.DateTimeFormat().resolvedOptions().timeZone,{updateOn:"blur"})})})});normalizaDateTimeLocal(e){let[t,o]=e.split("T",2),a=o.split(":");for(;a.length<3;)a.push("00");return`${t}T${a.join(":")}`}onSubmit(){let e=this.formGroup().getRawValue();e.start.dateTime=this.normalizaDateTimeLocal(e.start.dateTime),e.end.dateTime=this.normalizaDateTimeLocal(e.end.dateTime),this.formSubmit.emit(e)}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-event-create-form"]],inputs:{data:[1,"data"]},outputs:{formSubmit:"formSubmit",formCancel:"formCancel"},decls:26,vars:1,consts:[["ngNavtiveValidate","",3,"ngSubmit","formGroup"],["type","text","formControlName","summary","required",""],["type","text","formControlName","description"],["formGroupName","start"],["type","datetime-local","formControlName","dateTime","required",""],["formGroupName","end"],["type","submit"],["type","button"]],template:function(t,o){t&1&&(i(0,"form",0),u("ngSubmit",function(){return o.onSubmit()}),i(1,"label")(2,"b"),c(3,"Summary"),r(),f(4,"input",1),r(),f(5,"br"),i(6,"label")(7,"b"),c(8,"Description"),r(),f(9,"input",2),r(),f(10,"br"),i(11,"label",3)(12,"b"),c(13,"Start"),r(),f(14,"input",4),r(),f(15,"br"),i(16,"label",5)(17,"b"),c(18,"End"),r(),f(19,"input",4),r(),f(20,"br"),i(21,"div")(22,"button",6),c(23,"Create"),r(),i(24,"button",7),c(25,"Cancel"),r()()()),t&2&&v("formGroup",o.formGroup())},dependencies:[te,Y,O,I,W,Me,J,Z,Fe],encapsulation:2,changeDetection:0})};var st={eventTypes:["default","fromGmail"]},$e="https://www.googleapis.com/calendar/v3/calendars/primary/events",x=class n{http=s(L);oauthService=s(g);getAll(e){return Ve({request:e,loader:({request:t})=>he(()=>this.oauthService.getAccessTokenHeaders()).pipe(G(o=>this.http.get($e,{headers:m({},o),params:m(h(m({},st),{timeMin:(()=>{let a=new Date;return a.setFullYear(a.getFullYear()-1),a.toISOString()})()}),t)})))})}create(e){return he(()=>this.oauthService.getAccessTokenHeaders()).pipe(G(t=>this.http.post($e,e,{headers:m({},t)})))}static \u0275fac=function(t){return new(t||n)};static \u0275prov=T({token:n,factory:n.\u0275fac,providedIn:"root"})};var ce=class n{service=s(x);location=s(Ge);onFormSubmit(e){this.service.create(e).pipe(Ee(1)).subscribe(()=>{this.location.back()})}onFormCancel(){this.location.back()}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-event-create-page"]],decls:1,vars:0,consts:[[3,"formSubmit","formCancel"]],template:function(t,o){t&1&&(i(0,"app-gl-event-create-form",0),u("formSubmit",function(l){return o.onFormSubmit(l)})("formCancel",function(){return o.onFormCancel()}),r())},dependencies:[se],encapsulation:2,changeDetection:0})};function ct(n){return typeof n.date<"u"}function le(n){return typeof n.dateTime<"u"}function lt(n){if(le(n)){let e=n,{dateTime:o}=e,a=D(e,["dateTime"]);return h(m({},a),{dateTime:new Date(o)})}else{let t=n,{date:o}=t,a=D(t,["date"]);return h(m({},a),{date:new Date(`${o}T00:00:00`)})}}function mt(n){let l=n,{start:e,end:t}=l,o=D(l,["start","end"]);function a(S,j){return typeof j>"u"?{}:{[S]:m({},lt(j))}}return m(m(m({},o),a("start",e)),a("end",t))}function He(n){return h(m({},n),{items:(n?.items||[]).map(mt)})}function Qe(n){let[e,t]=(le(n)?n.dateTime:n.date).toISOString().split("T");return{date:e,time:ct(n)?null:t}}function F(n){if(le(n)){let{dateTime:e}=n;return e.toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"})}else{let{date:e}=n;return e.toLocaleDateString(void 0,{dateStyle:"medium"})}}function pt(n){return(le(n)?n.dateTime:n.date).toLocaleTimeString(void 0,{timeStyle:"short"})}function We(n){let{start:e,end:t}=n;if(e&&t){let o=Qe(e),a=Qe(t);return o.date===a.date?o.time===a.time?F(e):`${F(e)} - ${pt(t)}`:`${F(e)} to ${F(t)}`}else return e?F(e):t?F(t):"Unknown"}var dt=(n,e)=>e.id;function ut(n,e){if(n&1&&(i(0,"section")(1,"h3"),c(2),r(),i(3,"p"),c(4),r(),i(5,"footer"),c(6),r()()),n&2){let t=e.$implicit;p(2),k(t.summary),p(2),k(t.description),p(2),k(t.displayDateTime)}}function ft(n){let e=He(n),a=e,{items:t}=a,o=D(a,["items"]);return h(m({},e),{items:t.map(l=>h(m({},l),{displayDateTime:We(l)}))})}var me=class n{data=U.required();queryParams=U({});queryParamsChange=N();reload=N();parseData=b(()=>this.data()?ft(this.data()):void 0);fb=s(X).nonNullable;formGroup=b(()=>this.fb.group({q:this.fb.control(this.queryParams().q??"",{updateOn:"submit"})}));onSubmit(){this.queryParamsChange.emit(this.formGroup().getRawValue())}clear(){this.queryParamsChange.emit({})}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-events-list"]],inputs:{data:[1,"data"],queryParams:[1,"queryParams"]},outputs:{queryParamsChange:"queryParamsChange",reload:"reload"},decls:12,vars:1,consts:[[3,"ngSubmit","formGroup"],["type","text","formControlName","q"],["type","button",3,"click"]],template:function(t,o){if(t&1&&(i(0,"form",0),u("ngSubmit",function(){return o.onSubmit()}),i(1,"label")(2,"b"),c(3,"Search"),r(),f(4,"input",1),r(),i(5,"button",2),u("click",function(){return o.clear()}),c(6,"X"),r()(),i(7,"div")(8,"button",2),u("click",function(){return o.reload.emit()}),c(9," Reload"),r()(),be(10,ut,7,3,"section",null,dt)),t&2){let a;v("formGroup",o.formGroup()),p(10),Pe((a=o.parseData())==null?null:a.items)}},dependencies:[te,Y,O,I,W,J,Z],encapsulation:2,changeDetection:0})};var pe=class n{service=s(x);activatedRoute=s(H);queryParams=Ue(this.activatedRoute.queryParams,{initialValue:{}});dataResource=this.service.getAll(this.queryParams);router=s(C);onQueryParamsChange(e){this.router.navigate([],{queryParams:e,replaceUrl:!0})}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-events-list-page"]],decls:5,vars:2,consts:[["routerLink","create"],["type","button"],[3,"queryParamsChange","reload","data","queryParams"]],template:function(t,o){t&1&&(i(0,"div")(1,"a",0)(2,"button",1),c(3,"Create"),r()()(),i(4,"app-gl-events-list",2),u("queryParamsChange",function(l){return o.onQueryParamsChange(l)})("reload",function(){return o.dataResource.reload()}),r()),t&2&&(p(4),v("data",o.dataResource.value())("queryParams",o.queryParams()))},dependencies:[me,P],encapsulation:2,changeDetection:0})};var de=class n{constructor(){let e=s(H),t=s(C),o=e.snapshot.queryParams.code,a=e.snapshot.queryParams.state,l=s(g);(async()=>{if(o&&a){let S=await l.exchangeAuthorizationCode(o,a);t.navigateByUrl(S.intentedUrl)}})()}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-authorization-page"]],decls:2,vars:0,template:function(t,o){t&1&&(i(0,"p"),c(1,"gl-authorization-page works!"),r())},encapsulation:2,changeDetection:0})};function gt(n,e){n&1&&c(0," Loading... ")}function ht(n,e){if(n&1){let t=Ce();i(0,"button",1),u("click",function(){ve(t);let a=_();return ye(a.authorize())}),c(1,"Google.com"),r()}}function vt(n,e){if(n&1){let t=Ce();i(0,"div")(1,"button",1),u("click",function(){ve(t);let a=_();return ye(a.oauthService.clear())}),c(2,"Remove Token"),r()(),i(3,"nav")(4,"ul")(5,"li")(6,"a",2),c(7,"Event"),r()(),i(8,"li")(9,"a",3),c(10,"Contact"),r()()()(),f(11,"router-outlet")}}var yt=["profile","https://www.googleapis.com/auth/calendar.events","https://www.googleapis.com/auth/contacts"],ue=class n{oauthService=s(g);routerOutlet=s(C);async authorize(){let e=await this.oauthService.getAuthorizationCodeUrl(yt,{additionalParam:{prompt:"consent",access_type:"offline"},state:{intentedUrl:this.routerOutlet.url}});e&&(location.href=`${e}`)}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=d({type:n,selectors:[["app-gl-page"]],decls:3,vars:1,consts:[["type","button"],["type","button",3,"click"],["routerLink","events","routerLinkActive","app-st-active"],["routerLink","/google/contacts","routerLinkActive","app-st-active"]],template:function(t,o){if(t&1&&E(0,gt,1,0)(1,ht,2,0,"button",0)(2,vt,12,0),t&2){let a;ke((a=o.oauthService.ready())===void 0?0:a===!1?1:2)}},dependencies:[Le,P,Oe],encapsulation:2,changeDetection:0})};var fe=class n{async get(e){let t=localStorage.getItem(e);return JSON.parse(t??"null")}async set(e,t){let o=JSON.stringify(t);return localStorage.setItem(e,o)}async remove(e){return localStorage.removeItem(e)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=T({token:n,factory:n.\u0275fac,providedIn:"root"})};var ko=[{path:"",providers:[{provide:ae,useClass:fe},Be({name:"google",clientId:"209689905225-dj1bo29m0c7or5926cv4bb1nu5aru0cv.apps.googleusercontent.com",clientSecret:"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",authorizationCodeUrl:"https://accounts.google.com/o/oauth2/v2/auth",accessTokenUrl:"https://oauth2.googleapis.com/token",redirectUri:xe()?"http://localhost:4200/google/authorization ":"https://camt-mmit.github.io/2024-01-954447-001-lab08-09-api-Daifu-glitch/google/authorization "})],children:[{path:"authorization",component:de},{path:"",component:ue,children:[{path:"",redirectTo:"events",pathMatch:"full"},{path:"events",providers:[x],children:[{path:"",component:pe},{path:"create",component:ce}]},{path:"contacts",providers:[w],children:[{path:"",component:re},{path:"create",component:ie}]}]}]}];export{ko as default};
